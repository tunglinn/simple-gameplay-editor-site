<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Video Marker — Prototype</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:18px auto;padding:12px}
  header{display:flex;gap:12px;align-items:center}
  #video{width:100%;max-height:60vh;background:#000}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button,input,select{padding:8px;border-radius:6px;border:1px solid #ddd;background:#fff}
  #marks{margin-top:12px}
  .mark{display:flex;gap:8px;align-items:center;padding:6px;border:1px solid #eee;border-radius:6px;margin-bottom:6px}
  .time{font-family:monospace;width:90px}
  .small{font-size:0.9rem;padding:6px}
</style>
</head>
<body>
<header>
  <h2>Video Marker — Prototype</h2>
</header>

<input id="videoFile" type="file" accept="video/*" />
<video id="video" controls></video>

<div class="controls">
  <button id="serveBtn" class="small">Mark Serve</button>
  <button id="noPtBtn" class="small">Mark No Point</button>
  <button id="homePtBtn" class="small">Mark Home Point</button>
  <button id="awayPtBtn" class="small">Mark Away Point</button>
  <button id="prevBtn" class="small">Jump -5s</button>
  <button id="nextBtn" class="small">Jump +5s</button>
  <button id="exportJson" class="small">Export JSON</button>
  <button id="importJson" class="small">Import JSON</button>
  <button id="clearBtn" class="small">Clear Marks</button>
  <label style="margin-left:auto">Label: <input id="labelInput" placeholder="optional label" /></label>
</div>

<div id="marks">
  <h3>Marks</h3>
  <div id="marksList"></div>
</div>

<script>
const fileInput = document.getElementById('videoFile');
const video = document.getElementById('video');
const serveBtn = document.getElementById('serveBtn');
const noPtBtn = document.getElementById('noPtBtn');
const homePtBtn = document.getElementById('homePtBtn');
const awayPtBtn = document.getElementById('awayPtBtn');
const marksList = document.getElementById('marksList');
const exportBtn = document.getElementById('exportJson');
const importBtn = document.getElementById('importJson');
const clearBtn = document.getElementById('clearBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const labelInput = document.getElementById('labelInput');

let marks = [];
let currentFileName = null;

fileInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  currentFileName = f.name;

  // Check browser support for the file type
  const mime = f.type || '';
  const isSupported = video.canPlayType(mime) !== '';

  if (!isSupported) {
    // Show friendly message
    alert(
      `⚠️ This browser can't play ${f.name}.\n\n` +
      `Try converting it to MP4 (H.264 + AAC).\n\n` +
      `Example using FFmpeg:\n\n` +
      `ffmpeg -i "${f.name}" -c:v libx264 -c:a aac output.mp4`
    );
    video.removeAttribute('src'); // clear
    video.load();
    return;
  }

  // Otherwise, safe to load
  video.src = URL.createObjectURL(f);
  marks = [];
  refreshMarks();
});

function prettyTime(t){
  // mm:ss.s (one decimal)
  t = t/1000
  const minutes = Math.floor(t / 60);
  const seconds = (t % 60).toFixed(1).padStart(4,'0');
  return `${minutes}:${seconds}`;
}

function addMark(time, label=''){
  const mark = { time: Number(time * 1000), label: label || null };
  marks.push(mark);
  refreshMarks();
}

function refreshMarks(){
  marksList.innerHTML = '';
  marks.forEach((m, i)=>{
    const div = document.createElement('div');
    div.className = 'mark';
    div.innerHTML = `
      <div class="time">${prettyTime(m.time)}</div>
      <div style="flex:1"><input data-idx="${i}" class="editLabel" value="${m.label||''}" style="width:100%"/></div>
      <button data-idx="${i}" class="jump small">Jump</button>
      <button data-idx="${i}" class="del small">Delete</button>
    `;
    marksList.appendChild(div);
  });

  // attach handlers
  document.querySelectorAll('.jump').forEach(btn=>{
    btn.onclick = e => {
      const i = +btn.dataset.idx;
      video.currentTime = marks[i].time;
      video.play();
    };
  });
  document.querySelectorAll('.del').forEach(btn=>{
    btn.onclick = e => {
      const i = +btn.dataset.idx;
      marks.splice(i,1);
      refreshMarks();
    };
  });
  document.querySelectorAll('.editLabel').forEach(inp=>{
    inp.onchange = e => {
      const i = +inp.dataset.idx;
      marks[i].label = inp.value || null;
    };
  });
}

serveBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "Serve";
  addMark(video.currentTime, label);
};

noPtBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "No point";
  addMark(video.currentTime, label);
};

homePtBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "Home point";
  addMark(video.currentTime, label);
};

awayPtBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "Away point";
  addMark(video.currentTime, label);
};

prevBtn.onclick = ()=> video.currentTime = Math.max(0, video.currentTime - 5);
nextBtn.onclick = ()=> video.currentTime = Math.min(video.duration || 0, video.currentTime + 5);

clearBtn.onclick = ()=>{
  if(confirm('Clear all marks?')){ marks = []; refreshMarks(); }
};

exportBtn.onclick = ()=>{
  const out = {
    filename: currentFileName,
    created: new Date().toISOString(),
    duration: video.duration || null,
    marks: marks
  };
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (currentFileName ? currentFileName.replace(/\.[^/.]+$/, '') : 'video') + '_marks.json';
  a.click();
  URL.revokeObjectURL(url);
};

importBtn.onclick = ()=>{
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = async e=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data.marks || typeof data.marks !== 'object'){
        alert('Invalid JSON format.');
        return;
      }
      marks = [];
      for(const [i, mark] of Object.entries(data.marks)){
        const t = parseFloat(mark["time"]);
        const label = mark["label"]
        if(!isNaN(t)) marks.push({time:t/1000, label:label||""});
      }
      refreshMarks();
      alert('Marks imported successfully.');
    }catch(err){
      alert('Failed to read JSON: ' + err);
    }
  };
  inp.click();
};

// keyboard shortcut: M to mark
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 's') serveBtn.click();
  if(e.key.toLowerCase() === 'h') homePtBtn.click();
  if(e.key.toLowerCase() === 'a') awayPtBtn.click();
});

// basic mobile compatibility note: some mobile browsers restrict autoplay; user must tap play.
</script>
</body>
</html>
