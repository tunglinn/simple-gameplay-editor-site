<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video Marker — Prototype</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h2>Video Marker — Prototype</h2>
</header>
<details>
  <summary>Instructions</summary>
    <ol>
      <li>Enter team names</li>
      <li>Select video to mark</li>
      <li>Click "Enter Fullscreen" to use overlay buttons (or use the buttons below the video)</li>
      <li>Use the buttons to mark times (Serve, Home, Away, No Point)</li>
      <li>Export JSON</li>
      <li>Go to <a href="https://github.com/tunglinn/simple-gameplay-editor">github</a> and follow those instructions to process the video</li>
    </ol>
</details>

<input id="videoFile" type="file" accept="video/*" />
<button id="importJson" class="small">Import JSON</button>
<button id="fullScreenBtn" class="small">Enter Fullscreen</button>
<button id="exportJson" class="small">Export JSON</button>
<div id="scoreContainer">
  <label"><input id="homeNameInput" placeholder="Enter home team name"/></label>
  <span class="score">Home 0:0 Away</span>
  <label"><input id="awayNameInput" placeholder="Enter away team name"/></label>
</div>
<div id="videoContainer">
  <video id="video" controls preload="auto" playsinline></video>
  <div id="hideController">
    <div class="controller-overlay" id="controllerOverlay">
      <div class="utility-bg">
        <button id="exitFullscreen" class="small">Exit</button>
        <span class="score" id="white-text">Home 0:0 Away</span>
        <select id="markerDropdown">
          <option value="default" selected hidden>Marker list</option>
        </select>
      </div>
      <div class="controller-bg">
          <div class="dpad">
            <button class="btn left" data-action="left">◀</button>
            <button class="btn right" data-action="right">▶</button>
          </div>
          <div class="cluster">
            <button class="btn abxy-b" data-action="b">NP</button>
            <button class="btn abxy-y" data-action="y">A</button>
            <button class="btn abxy-x" data-action="x">H</button>
            <button class="btn abxy-a" data-action="a">S</button>
          </div>
      </div>
    </div>
  </div>
</div>

<div class="controls">
  <button id="serveBtn" class="small">Mark Serve</button>
  <button id="noPtBtn" class="small">Mark No Point</button>
  <button id="homePtBtn" class="small">Mark Home Point</button>
  <button id="awayPtBtn" class="small">Mark Away Point</button>
  <button id="prevBtn" class="small">Jump -5s</button>
  <button id="nextBtn" class="small">Jump +5s</button>
  <button id="clearBtn" class="small">Clear Marks</button>
  <label style="margin-left:auto">Label: <input id="labelInput" placeholder="optional label" /></label>
</div>

<div id="marks">
  <h3>Marks</h3>
  <div id="marksList"></div>
</div>

<script>
const fileInput = document.getElementById('videoFile');
const video = document.getElementById('video');
const serveBtn = document.getElementById('serveBtn');
const noPtBtn = document.getElementById('noPtBtn');
const homePtBtn = document.getElementById('homePtBtn');
const awayPtBtn = document.getElementById('awayPtBtn');
const marksList = document.getElementById('marksList');
const exportBtn = document.getElementById('exportJson');
const importBtn = document.getElementById('importJson');
const clearBtn = document.getElementById('clearBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const labelInput = document.getElementById('labelInput');
const exitFullscreen = document.getElementById('exitFullscreen');
const scoreSpans = document.querySelectorAll('.score');

let marks = [];
let currentFileName = null;

fileInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  currentFileName = f.name;

  // Check browser support for the file type
  const mime = f.type || '';
  const isSupported = video.canPlayType(mime) !== '';

  if (!isSupported) {
    // Show friendly message
    alert(
      `⚠️ This browser can't play ${f.name}.\n\n` +
      `Try converting it to MP4 (H.264 + AAC).\n\n` +
      `Example using FFmpeg:\n\n` +
      `ffmpeg -i "${f.name}" -c:v libx264 -c:a aac output.mp4`
    );
    video.removeAttribute('src'); // clear
    video.load();
    return;
  }

  // Otherwise, safe to load
  video.src = URL.createObjectURL(f);
  marks = [];
  refreshMarks();
});

function prettyTime(t){
  // mm:ss.s (one decimal)
  t = t/1000
  const minutes = Math.floor(t / 60);
  const seconds = (t % 60).toFixed(1).padStart(4,'0');
  return `${minutes}:${seconds}`;
}

function sortMarks(){
  console.log("sorting")
  marks.sort((a,b) => a["time"] - b["time"])
}

function addMark(time, label=''){
  const mark = { time: Number(time * 1000), label: label || null };
  marks.push(mark);
  refreshMarks();
}

function refreshMarks(){
  sortMarks()
  marksList.innerHTML = '';
  marks.forEach((m, i)=>{
    const div = document.createElement('div');
    div.className = 'mark';
    is_serve = m.label==="Serve"
    if(is_serve) {
      div.innerHTML = `
        <div class="time">${prettyTime(m.time)}</div>
        <div style="flex:1;display: flex">
          <input data-idx="${i}" class="editLabel" value="${m.label||''}" style="width:100%"/>
        </div>
        <button data-idx="${i}" class="jump small">Jump</button>
        <button data-idx="${i}" class="del small">Delete</button>
      `;
    }
    else {
      div.innerHTML = `
        <div class="time">${prettyTime(m.time)}</div>
        <div style="flex:1;display: flex">
          <input data-idx="${i}" class="editLabel" value="${m.label||''}" style="width:100%"/>
          <label for="highlightCheckbox" style="align-content:center;padding:5px">Highlight?</label>
          <input type="checkbox" id="highlightCheckbox"/>
        </div>
        <button data-idx="${i}" class="jump small">Jump</button>
        <button data-idx="${i}" class="del small">Delete</button>
      `;
    }
    
    marksList.appendChild(div);
  });

  // attach handlers
  document.querySelectorAll('.jump').forEach(btn=>{
    btn.onclick = e => {
      const i = +btn.dataset.idx;
      video.currentTime = marks[i].time / 1000;
    };
  });
  document.querySelectorAll('.del').forEach(btn=>{
    btn.onclick = e => {
      const i = +btn.dataset.idx;
      marks.splice(i,1);
      refreshMarks();
    };
  });
  document.querySelectorAll('.editLabel').forEach(inp=>{
    inp.onchange = e => {
      const i = +inp.dataset.idx;
      marks[i].label = inp.value || null;
    };
  });
  refreshDropdown()
}

serveBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "Serve";
  addMark(video.currentTime, label);
};

noPtBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "No point";
  addMark(video.currentTime, label);
};

homePtBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "Home point";
  addMark(video.currentTime, label);
};

awayPtBtn.onclick = ()=>{
  if(!video.src){
    alert('Please load a video file first.');
    return;
  }
  const label = "Away point";
  addMark(video.currentTime, label);
};

prevBtn.onclick = ()=> video.currentTime = Math.max(0, video.currentTime - 5);
nextBtn.onclick = ()=> video.currentTime = Math.min(video.duration || 0, video.currentTime + 5);

clearBtn.onclick = ()=>{
  if(confirm('Clear all marks?')){ marks = []; refreshMarks(); }
};

exportBtn.onclick = ()=>{
  const home_name = document.querySelector("#homeNameInput")
  const away_name = document.querySelector("#awayNameInput")
  const out = {
    filename: currentFileName,
    created: new Date().toISOString(),
    duration: video.duration || null,
    home: home_name,
    away: away_name,
    marks: marks
  };
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (currentFileName ? currentFileName.replace(/\.[^/.]+$/, '') : 'video') + '_marks.json';
  a.click();
  URL.revokeObjectURL(url);
};

importBtn.onclick = ()=>{
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = async e=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data.marks || typeof data.marks !== 'object'){
        alert('Invalid JSON format.');
        return;
      }
      marks = [];
      for(const [i, mark] of Object.entries(data.marks)){
        const t = parseFloat(mark["time"]);
        const label = mark["label"]
        if(!isNaN(t)) marks.push({time:t, label:label||""});
      }
      refreshMarks();
      alert('Marks imported successfully.');
    }catch(err){
      alert('Failed to read JSON: ' + err);
    }
  };
  inp.click();
};

// keyboard shortcut: M to mark
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 's') serveBtn.click();
  if(e.key.toLowerCase() === 'h') homePtBtn.click();
  if(e.key.toLowerCase() === 'a') awayPtBtn.click();
  if(e.key.toLowerCase() === 'j') noPtBtn.click();
});

// Score Display

function updateScore(home, away) {
  scoreSpans.forEach(span => {
    span.textContent = `Home ${home}:${away} Away`;
  });
}

video.addEventListener("timeupdate", () =>  {
  const current = video.currentTime;

  // Calculate score
  let home = 0;
  let away = 0;
  for (let i = marks.length - 1; i >= 0; i--) {
    if (current >= marks[i].time / 1000) {
      switch (marks[i].label) {
        case 'Home point':
          home++;
          break;
        case 'Away point':
          away++;
          break;
      }
    }
  }
  updateScore(home, away)
})

// Controller Overlay

function refreshDropdown() {
  const select = document.getElementById("markerDropdown");
  select.innerHTML = ""; // clear

  marks.forEach(mark => {
    const option = document.createElement("option");

    // value should be the time
    option.value = mark.time;

    // If label is null, show just "(time)"
    if (mark.label) {
        option.textContent = `${mark.label} (${prettyTime(mark.time)})`;
    } else {
        option.textContent = `(${prettyTime(mark.time)})`;
    }

    if (selectedMarker !== null && mark === selectedMarker) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

document.getElementById("markerDropdown").addEventListener("change", (e) => {
    const time = e.target.value;
    video.currentTime = time / 1000;
});

// === Fullscreen + controller overlay ===
const hiddenLayer = document.getElementById('hideController');
const overlay = document.getElementById('controllerOverlay');
const container = document.getElementById('videoContainer');
const fullScreen = document.getElementById('fullScreenBtn')

// When video enters fullscreen, show overlay
document.addEventListener('fullscreenchange', () => {
  if (document.fullscreenElement === container) {
    hiddenLayer.classList.add('visible');
  } else {
    hiddenLayer.classList.remove('visible');
  }
});


fullScreen.onclick = () => {
  const container = document.getElementById('videoContainer');
  if (!document.fullscreenElement) container.requestFullscreen();
  else document.exitFullscreen();
};

exitFullscreen.onclick = () => {
  document.exitFullscreen()
}

// Dispatch custom "game-control" events for your own handlers
function triggerControl(action){
  overlay.dispatchEvent(new CustomEvent('game-control',{detail:{action}}));
}

// Button clicks
overlay.querySelectorAll('.btn').forEach(btn=>{
  btn.onclick = ()=>{
    const action = btn.dataset.action;
    triggerControl(action);
  };
});

// Keyboard controls while fullscreen
document.addEventListener('keydown',(e)=>{
  if(!document.fullscreenElement) return;
  const key = e.key.toLowerCase();
  if(key==='arrowleft') triggerControl('left');
  if(key==='arrowright') triggerControl('right');
  if(['a','b','x','y'].includes(key)) triggerControl(key);
});

// Example: listen to game-control events (you can wire real actions)
overlay.addEventListener('game-control',(e)=>{
  const a = e.detail.action;
  console.log('game-control:',a);
  if(a==='left') prevBtn.click();
  if(a==='right') nextBtn.click();
  if(a==='a') serveBtn.click();
  if(a==='b') noPtBtn.click();
  if(a==='x') homePtBtn.click();
  if(a==='y') awayPtBtn.click();
});



// basic mobile compatibility note: some mobile browsers restrict autoplay; user must tap play.
</script>

</body>
</html>
